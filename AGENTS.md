# NixOS Configuration — Agent Instructions

> Project overrides for the global `AGENTS.md`. This is a NixOS flake configuration repository managing multiple hosts.

## 1) Context

**Purpose:** Declarative NixOS system and home-manager configuration for multiple machines, using flakes with flake-parts.
**Hosts:** `workLaptop`, `personalLaptop`
**Stack:** Nix (flakes, flake-parts, home-manager), agenix for secrets, Hyprland + GNOME desktop

## 1.5) Context Loading (Files to read on init)

- `AGENTS.md` / `CLAUDE.md` (project instructions)
- `README.md`
- `flake.nix` (inputs and top-level structure)
- `hosts/default.nix` (host composition logic)
- `Makefile` (build/deploy entry points)
- `secrets/secrets.nix` (agenix secret declarations — do not edit encrypted `.age` files)

## 2) Clarify-First (Stop and ask before proceeding)

Ask the user before changes that involve:
- Bootloader or kernel configuration
- Filesystem layout, partitioning, or mount points
- Hardware-configuration.nix edits (auto-generated)
- Secret management (agenix keys, re-encryption)
- Flake input additions or removals
- Changes that affect both hosts differently

If acceptance criteria are unclear, propose 2 options with trade-offs.

## 3) Generated / Pinned Files (Do not hand-edit)

- `hosts/{hostname}/hardware-configuration.nix` — generated by `nixos-generate-config`
- `flake.lock` — managed by `nix flake update`; do not edit manually
- `secrets/*.age` — encrypted by agenix; use `agenix -e` to modify

## 4) Repo Map (Where to edit)

- Flake entry point: `flake.nix`
- Host composition: `hosts/default.nix`
- Per-host config: `hosts/{hostname}/default.nix`
- Core system modules: `system/core/default.nix`
- Hardware drivers: `system/hardware/` (GPU modules)
- Program configs: `system/programs/` (Hyprland, terminal, VSCodium)
- Secrets declarations: `secrets/secrets.nix`
- Home-manager base: `home/default.nix`
- Per-host home profiles: `home/profiles/{hostname}.nix`
- Additional modules: `modules/` (e.g. quickshell)
- Helpers: `lib/`
- Build entry point: `Makefile`

## 5) Build / Deploy (Copy-paste)

Set `HOST` first (in `.env` or via export):
```bash
export HOST=workLaptop  # or personalLaptop
```

```bash
# Build only (no sudo)
make build

# Test without persisting
make test

# Rebuild and switch immediately
make switch

# Update flake inputs
make update
```

## 6) Verification

- No dedicated test suite. Use `make build` for a dry build and `make test` to validate activation.
- If changing modules, test at least one target host with `make build`.
- Record what you built/observed if no automated check covers the change.

## 7) Never

- Don't commit secrets or age private keys.
- Don't hand-edit `hardware-configuration.nix`, `flake.lock`, or `*.age` files.
- Don't run `make switch` without explicit user confirmation (it requires sudo and activates immediately).
- Don't remove or downgrade flake inputs without asking first.

## Coding Style

- Nix files: 2-space indentation, trailing commas where already present.
- Follow existing module patterns: lowerCamelCase options, clear section headers, minimal duplication.
- Host-specific changes go in `hosts/<host>/`; shared logic in `system/`, `home/`, `modules/`, or `lib/`.

## Commits

- Conventional Commit prefixes (`feat:`, `fix:`, `refactor:`, `chore:`).
- Keep messages short, scoped, and in imperative mood.
- Include target host(s) tested when relevant.
